<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>DistributedTransaction - Hexo</title><meta description="分布式事务事务简介 事务是用来保证一组数据操作的完整性和一致性 事务必须满足ACID的四大特性（待补全） 事务具有四种隔离级别（待补全） 事务具有七种传播行为（待补全）"><meta property="og:type" content="blog"><meta property="og:title" content="DistributedTransaction"><meta property="og:url" content="http://yoursite.com/2020/07/26/DistributedTransaction/"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="分布式事务事务简介 事务是用来保证一组数据操作的完整性和一致性 事务必须满足ACID的四大特性（待补全） 事务具有四种隔离级别（待补全） 事务具有七种传播行为（待补全）"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://yoursite.com/2020/07/26/DistributedTransaction/3.png"><meta property="og:image" content="http://yoursite.com/2020/07/26/DistributedTransaction/4.png"><meta property="og:image" content="http://yoursite.com/2020/07/26/DistributedTransaction/5.png"><meta property="og:image" content="http://yoursite.com/2020/07/26/DistributedTransaction/6.png"><meta property="og:image" content="http://yoursite.com/2020/07/26/DistributedTransaction/7.png"><meta property="og:image" content="http://yoursite.com/2020/07/26/DistributedTransaction/8.png"><meta property="article:published_time" content="2020-07-26T10:30:01.000Z"><meta property="article:modified_time" content="2020-07-26T10:34:50.476Z"><meta property="article:author" content="Jiayi Yang"><meta property="article:tag" content="Distribution"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2020/07/26/DistributedTransaction/3.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://yoursite.com/2020/07/26/DistributedTransaction/"},"headline":"Hexo","image":["http://yoursite.com/2020/07/26/DistributedTransaction/3.png","http://yoursite.com/2020/07/26/DistributedTransaction/4.png","http://yoursite.com/2020/07/26/DistributedTransaction/5.png","http://yoursite.com/2020/07/26/DistributedTransaction/6.png","http://yoursite.com/2020/07/26/DistributedTransaction/7.png","http://yoursite.com/2020/07/26/DistributedTransaction/8.png"],"datePublished":"2020-07-26T10:30:01.000Z","dateModified":"2020-07-26T10:34:50.476Z","author":{"@type":"Person","name":"Jiayi Yang"},"description":"分布式事务事务简介 事务是用来保证一组数据操作的完整性和一致性 事务必须满足ACID的四大特性（待补全） 事务具有四种隔离级别（待补全） 事务具有七种传播行为（待补全）"}</script><link rel="canonical" href="http://yoursite.com/2020/07/26/DistributedTransaction/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.12.0/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css"><link rel="stylesheet" href="https://fonts.loli.net/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/JiayiY"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-07-26T10:30:01.000Z" title="2020-07-26T10:30:01.000Z">2020-07-26</time><span class="level-item">24 分钟 读完 (大约 3669 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">DistributedTransaction</h1><div class="content"><h1 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h1><h2 id="事务简介"><a href="#事务简介" class="headerlink" title="事务简介"></a>事务简介</h2><ul>
<li>事务是用来保证一组数据操作的完整性和一致性</li>
<li>事务必须满足ACID的四大特性（待补全）</li>
<li>事务具有四种隔离级别（待补全）</li>
<li>事务具有七种传播行为（待补全）</li>
</ul>
<a id="more"></a>

<h2 id="什么是分布式事务"><a href="#什么是分布式事务" class="headerlink" title="什么是分布式事务"></a>什么是分布式事务</h2><p>分布式事务就是将多个节点的事务看成一个整体处理。</p>
<p>分布式事务由事务参与者、资源服务器、事务管理器等组成，常见例子有，支付、下订单等。</p>
<h2 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h2><h3 id="两段式事务"><a href="#两段式事务" class="headerlink" title="两段式事务"></a>两段式事务</h3><p><img src="/2020/07/26/DistributedTransaction/3.png" alt="两段式事务"></p>
<p>请求阶段：协调者向参与者询问是否可以进行事务提交操作，然后开始等待参与者的响应。</p>
<p>提交阶段：在该阶段，协调者将基于第一个阶段的投票结果进行决策：提交或取消。当且仅当所有的参与者同意提交，事务协调者才通知所有的参与者提交事务，否则协调者将通知所有的参与者回滚事务。</p>
<p>缺点：1）当参与者占有公共资源时，其他第三方节点访问公共资源不得不处于阻塞状态；2）当协调者出错，那么所有的参与者还都处于锁定事务资源的状态中，而无法继续完成事务操作；3）假如在第二阶段中，假如协调者发出commit消息后宕机，接收到这条消息的参与者宕机，此时则无法判断事务状态，无法确定是否已被提交；</p>
<h3 id="三段式事务"><a href="#三段式事务" class="headerlink" title="三段式事务"></a>三段式事务</h3><p>事务询问 -&gt; 执行事务预提交 -&gt; 进行事务提交或者事务回滚</p>
<p>降低了参与者的阻塞范围，但引入了新问题：在参与者接收到precommit后，网络出现问题，参与者和协调者无法通行，在这种情况下，参与者依然会执行事务的提交。</p>
<h3 id="基于XA的分布式事务"><a href="#基于XA的分布式事务" class="headerlink" title="基于XA的分布式事务"></a>基于XA的分布式事务</h3><p><img src="/2020/07/26/DistributedTransaction/4.png" alt="基于XA的分布式事务"></p>
<p>缺点：1）性能较差；2）很多nosql不支持XA协议；</p>
<h3 id="基于消息的最终一致性方案"><a href="#基于消息的最终一致性方案" class="headerlink" title="基于消息的最终一致性方案"></a>基于消息的最终一致性方案</h3><p><img src="/2020/07/26/DistributedTransaction/5.png" alt="基于消息的最终一致性方案"></p>
<p>缺点：属于强一致性事务，会存在资源浪费</p>
<h3 id="TCC编程式补偿性事务"><a href="#TCC编程式补偿性事务" class="headerlink" title="TCC编程式补偿性事务"></a>TCC编程式补偿性事务</h3><p><img src="/2020/07/26/DistributedTransaction/6.png" alt="TCC补偿性事务"></p>
<p>TCC事务是柔性事务，在try阶段要对资源做预留，在confirm或cancel阶段释放资源，与基于消息事务对比，TCC的时效性更好。</p>
<p>TCC模型是把锁的粒度完全交给业务处理，它分为三个阶段：</p>
<ol>
<li>Try阶段主要是对业务系统做检测及资源预留；</li>
<li>如果try阶段所有业务资源都预留成功，则执行confirm，否则执行cancel；</li>
</ol>
<ul>
<li>confirm：不做任务业务检查，仅使用预留的资源执行业务操作，失败会重试；</li>
<li>cancel：取消执行业务操作，释放预留的资源，失败会重试；</li>
</ul>
<h4 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h4><p>以简单的电商系统为例，小明在淘宝上花100元买了一本书，获赠10个积分，产生如下操作：</p>
<ul>
<li>订单系统创建商品订单；</li>
<li>支付系统接受小明的支付；</li>
<li>库存系统扣减产品库存；</li>
<li>会员系统给小明账户增加会员积分；</li>
</ul>
<p>这几个动作需要作为一个事务执行，要同时成功或者同时撤销。如果采用TCC事务模式，那么各个系统需要改造为如下状态：</p>
<blockquote>
<p>1）订单系统</p>
<p>try：创建一个订单，状态显示为“待支付”；</p>
<p>confirm：更新订单的状态为“已完成”；</p>
<p>cancel：更新订单的状态为“已取消”；<br>2）支付系统</p>
<p>try：假设小明账户中有1000元，冻结小明账户中的100元，此时小明看到的余额依然是1000元；</p>
<p>confirm：将账户余额变为900元，并清除冻结记录；</p>
<p>concel：清除冻结记录；<br>3）库存系统</p>
<p>try：假设库存中还生10本书，冻结其中的一本书，现实库存依然有10本书；</p>
<p>confirm：将剩余库存更新为9本书，并清除冻结记录；</p>
<p>cancel：清除冻结记录；<br>4）会员系统</p>
<p>try：假设小明原因积分为3000，给小明账户预增加10积分，账户显示的积分依然是3000分；</p>
<p>confirm：将账户积分更新为3010，并清除预增加记录；</p>
<p>cancel：清除预增加记录；</p>
</blockquote>
<p>缺点：TCC 事务模型对业务方侵入较大，需要业务方把功能的实现上由一个接口拆分为三个，开发成本较高。</p>
<p>同时 TCC 事务为了解决异步网络中的通信失败或超时带来的异常情况，要求业务方在设计实现上要遵循三个策略：</p>
<ul>
<li><p>允许空回滚：原因是异常发生在阶段 1 时，部分参与方没有收到 try 请求从而触发整个事务的 cancel 操作，try 失败或者没有执行 try 操作的参与方收到 cancel 请求时，要进行空回滚操作；</p>
</li>
<li><p>保持幂等性：原因是异常发生在阶段 2 时，比如网络超时，则会重复调用参与方的 confirm/cancel 方法，因此需要这两个方法实现上保证幂等性；</p>
</li>
<li><p>防止资源悬挂：原因网络异常导致两个阶段无法保证严格的顺序执行，出现参与方侧 try 请求比 cancel 请求更晚到达的情况，cancel 会执行空回滚而确保事务的正确性，但是此时 try 方法也不可以再被执行；</p>
</li>
</ul>
<h2 id="分布式事务框架"><a href="#分布式事务框架" class="headerlink" title="分布式事务框架"></a>分布式事务框架</h2><ul>
<li><p>全局事务框架GTS</p>
</li>
<li><p>蚂蚁金服分布式事务DTX</p>
</li>
<li><p>开源TCC框架TCC-Transaction（<a href="https://github.com/changmingxie/tcc-transaction）">https://github.com/changmingxie/tcc-transaction）</a></p>
</li>
<li><p>开源TCC框架Byte-（<a href="https://github.com/liuyangming/ByteTCC）">https://github.com/liuyangming/ByteTCC）</a></p>
</li>
</ul>
<h2 id="TCC-Transaction分析"><a href="#TCC-Transaction分析" class="headerlink" title="TCC-Transaction分析"></a>TCC-Transaction分析</h2><p><img src="/2020/07/26/DistributedTransaction/7.png" alt="TCC-Transaction-Core"></p>
<p>仓库：<a href="https://github.com/changmingxie/tcc-transaction">https://github.com/changmingxie/tcc-transaction</a></p>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><ol>
<li>在需要提供分布式事务支持的接口方法上添加 <code>@Compensable</code>；</li>
<li>在对应的接口实现方法上也添加 @Compensable，并添加注解参数 <code>confirmMethod</code>, <code>cancelMethod</code> 和 <code>transactionContextEditor</code>；</li>
<li>实现对应的 <code>confirmMethod</code> 和 <code>cancelMethod</code>（必须和 try 方法在同一个类中）；</li>
</ol>
<p>注意：</p>
<ol>
<li>在分布式事务框架中，不要轻易在业务层捕获所有异常，只有在抛出异常的情况下，分布式事务框架才知道该业务是执行失败的，继而执行<code>cancelMethod</code>；</li>
<li>使用 TCC-Transaction 时，confirm 和 cancel 的幂等性问题需要人为代码保证；</li>
<li>TCC 的数据库应该和业务数据库分开，以保证分布式事务的正常进行；</li>
</ol>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p><img src="/2020/07/26/DistributedTransaction/8.png" alt="框架调用流程"></p>
<p>tcc的事务并不是数据库的事务，而是应用层的事务，Transaction如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Transaction</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">7291423944314337931L</span>;</span><br><span class="line">    <span class="comment">// 全局事务id，用来保证事务唯一性</span></span><br><span class="line">    <span class="keyword">private</span> TransactionXid xid;</span><br><span class="line">    <span class="comment">// 事务的状态</span></span><br><span class="line">    <span class="keyword">private</span> TransactionStatus status;</span><br><span class="line">    <span class="comment">// 事务类型，ROOT是主事务，BRANCH是分支事务</span></span><br><span class="line">    <span class="keyword">private</span> TransactionType transactionType;</span><br><span class="line">	<span class="comment">// 事务重试次数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> retriedCount = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 事务创建时间</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime = <span class="keyword">new</span> Date();</span><br><span class="line">	<span class="comment">// 事务最后一次更新的时间</span></span><br><span class="line">    <span class="keyword">private</span> Date lastUpdateTime = <span class="keyword">new</span> Date();</span><br><span class="line">	<span class="comment">// 事务的版本号</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> version = <span class="number">1</span>;</span><br><span class="line">	<span class="comment">// 事务的参与者</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Participant&gt; participants = <span class="keyword">new</span> ArrayList&lt;Participant&gt;();</span><br><span class="line">	<span class="comment">// 附加参数</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; attachments = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CompensableTransactionAspect是一个AOP切面类，<code>@Pointcut</code> 将 <code>@Compensable</code> 注解标记为切入点，其签名为<code>compensableService()</code>。<code>@Around</code> 表示在<code>compensableService()</code>之前和之后调用 <code>interceptCompensableMethod()</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CompensableTransactionAspect</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CompensableTransactionInterceptor compensableTransactionInterceptor;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCompensableTransactionInterceptor</span><span class="params">(CompensableTransactionInterceptor compensableTransactionInterceptor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.compensableTransactionInterceptor = compensableTransactionInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(org.mengyun.tcctransaction.api.Compensable)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">compensableService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"compensableService()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptCompensableMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> compensableTransactionInterceptor.interceptCompensableMethod(pjp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CompensableTransactionInterceptor是事务拦截器，具有以下作用：</p>
<ol>
<li>将事务区分为ROOT事务和PROVIDER分支事务；</li>
<li>不断地修改数据库内的状态（初始化事务、修改事务状态）；</li>
<li>修改和清除事务管理区中的事务队列；</li>
<li>并没有执行目标对象方法，pjp.proceed() 其实是交给了下一个拦截器 ResourceCoordinatorInterceptor；</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompensableMethodContext</span> </span>&#123;</span><br><span class="line">    ProceedingJoinPoint pjp = <span class="keyword">null</span>;</span><br><span class="line">    Method method = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// 解析得到的Compensable注解</span></span><br><span class="line">    Compensable compensable = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    Propagation propagation = <span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">// 保存了全局事务id和事务状态，在调用事务参与者Participant的confirm或cancel方法时会传递过去。</span></span><br><span class="line">    TransactionContext transactionContext = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CompensableMethodContext</span><span class="params">(ProceedingJoinPoint pjp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pjp = pjp;</span><br><span class="line">        <span class="keyword">this</span>.method = getCompensableMethod();</span><br><span class="line">        <span class="keyword">this</span>.compensable = method.getAnnotation(Compensable<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">this</span>.propagation = compensable.propagation();</span><br><span class="line">        <span class="keyword">this</span>.transactionContext = FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().get(pjp.getTarget(), method, pjp.getArgs());</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CompensableTransactionInterceptor</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">interceptCompensableMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    	<span class="comment">// 通过pjp解析各种属性，组成CompansableMethodContext对象</span></span><br><span class="line">    	CompensableMethodContext compensableMethodContext = <span class="keyword">new</span> CompensableMethodContext(pjp);</span><br><span class="line">    	<span class="comment">// 是否有存在的事务队列（从ThreadLocal获取transactions来判断当前线程是否已经有事务）</span></span><br><span class="line">    	<span class="keyword">boolean</span> isTransactionActive = transactionManager.isTransactionActive();</span><br><span class="line">    	<span class="keyword">if</span> (!TransactionUtils.isLegalTransactionContext(isTransactionActive, compensableMethodContext)) &#123;</span><br><span class="line">        	<span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"no active compensable transaction while propagation is mandatory for method "</span> + compensableMethodContext.getMethod().getName());</span><br><span class="line">    	&#125;</span><br><span class="line">		<span class="comment">// 获取并判断当前事务的角色（ROOT表示主事务，PROVIDER表示分支事务或事务参与者），并根据其角色调用不同的方法来处理。</span></span><br><span class="line">    	<span class="keyword">switch</span> (compensableMethodContext.getMethodRole(isTransactionActive)) &#123;</span><br><span class="line">        	<span class="comment">// 处理主事务切面</span></span><br><span class="line">        	<span class="keyword">case</span> ROOT:</span><br><span class="line">            	<span class="keyword">return</span> rootMethodProceed(compensableMethodContext);</span><br><span class="line">        	<span class="comment">// 处理PROVIDER事务切面</span></span><br><span class="line">        	<span class="keyword">case</span> PROVIDER:</span><br><span class="line">            	<span class="keyword">return</span> providerMethodProceed(compensableMethodContext);</span><br><span class="line">        	<span class="keyword">default</span>:</span><br><span class="line">            	<span class="keyword">return</span> pjp.proceed();</span><br><span class="line">    	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. 开启全局事务</span></span><br><span class="line"><span class="comment">     * 2. 持久化全局事务</span></span><br><span class="line"><span class="comment">     * 3. 注册全局事务</span></span><br><span class="line"><span class="comment">     * 4. 判断应该是confirm还是cancel</span></span><br><span class="line"><span class="comment">     * 5. 清除事务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> compensableMethodContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">rootMethodProceed</span><span class="params">(CompensableMethodContext compensableMethodContext)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Object returnValue = <span class="keyword">null</span>;</span><br><span class="line">        Transaction transaction = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> asyncConfirm = compensableMethodContext.getAnnotation().asyncConfirm();</span><br><span class="line">        <span class="keyword">boolean</span> asyncCancel = compensableMethodContext.getAnnotation().asyncCancel();</span><br><span class="line">        Set&lt;Class&lt;? extends Exception&gt;&gt; allDelayCancelExceptions = <span class="keyword">new</span> HashSet&lt;Class&lt;? extends Exception&gt;&gt;();</span><br><span class="line">        allDelayCancelExceptions.addAll(<span class="keyword">this</span>.delayCancelExceptions);</span><br><span class="line">        	allDelayCancelExceptions.addAll(Arrays.asList(compensableMethodContext.getAnnotation().delayCancelExceptions()));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 开启一个全新的事务</span></span><br><span class="line"><span class="comment">             * 1. 持久化事务形态 -&gt; 全局事务编号</span></span><br><span class="line"><span class="comment">             * 2. 注册一个事务【ThreadLocal】</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            transaction = transactionManager.begin(compensableMethodContext.getUniqueIdentity());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 执行后续方法</span></span><br><span class="line">                returnValue = compensableMethodContext.proceed();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable tryingException) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!isDelayCancelException(tryingException, allDelayCancelExceptions)) &#123;</span><br><span class="line">                    logger.warn(String.format(<span class="string">"compensable transaction trying failed. transaction content:%s"</span>, JSON.toJSONString(transaction)), tryingException);</span><br><span class="line">                    <span class="comment">// 回滚事务</span></span><br><span class="line">                    transactionManager.rollback(asyncCancel);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">throw</span> tryingException;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 提交事务</span></span><br><span class="line">            transactionManager.commit(asyncConfirm);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 清除队列中的事务</span></span><br><span class="line">            transactionManager.cleanAfterCompletion(transaction);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> returnValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">providerMethodProceed</span><span class="params">(CompensableMethodContext compensableMethodContext)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Transaction transaction = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> asyncConfirm = compensableMethodContext.getAnnotation().asyncConfirm();</span><br><span class="line">        <span class="keyword">boolean</span> asyncCancel = compensableMethodContext.getAnnotation().asyncCancel();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (TransactionStatus.valueOf(compensableMethodContext.getTransactionContext().getStatus())) &#123;</span><br><span class="line">                <span class="keyword">case</span> TRYING:</span><br><span class="line">                    <span class="comment">// 初始化一份事务参与者的数据进入到当前服务中，并向事务管理器注册事务</span></span><br><span class="line">                    transaction = transactionManager.propagationNewBegin(compensableMethodContext.getTransactionContext());</span><br><span class="line">                    <span class="keyword">return</span> compensableMethodContext.proceed();</span><br><span class="line">                <span class="keyword">case</span> CONFIRMING:</span><br><span class="line">                    <span class="comment">// 修改状态</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        transaction = transactionManager.propagationExistBegin(compensableMethodContext.getTransactionContext());</span><br><span class="line">                        <span class="comment">// 修改事务状态为CONFIRMING，并持久化更新，提交事务</span></span><br><span class="line">                        transactionManager.commit(asyncConfirm);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoExistedTransactionException excepton) &#123;</span><br><span class="line">                        <span class="comment">//the transaction has been commit,ignore it.</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> CANCELLING:</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        transaction = transactionManager.propagationExistBegin(compensableMethodContext.getTransactionContext());</span><br><span class="line">                        <span class="comment">// 修改事务状态为 CANCELLING，并持久化更新，回滚事务</span></span><br><span class="line">                        transactionManager.rollback(asyncCancel);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoExistedTransactionException exception) &#123;</span><br><span class="line">                        <span class="comment">//the transaction has been rollback,ignore it.</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 清除事务</span></span><br><span class="line">            transactionManager.cleanAfterCompletion(transaction);</span><br><span class="line">        &#125;</span><br><span class="line">        Method method = compensableMethodContext.getMethod();</span><br><span class="line">        <span class="keyword">return</span> ReflectionUtils.getNullValue(method.getReturnType());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isDelayCancelException</span><span class="params">(Throwable throwable, Set&lt;Class&lt;? extends Exception&gt;&gt; delayCancelExceptions)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (delayCancelExceptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Class delayCancelException : delayCancelExceptions) &#123;</span><br><span class="line">                Throwable rootCause = ExceptionUtils.getRootCause(throwable);</span><br><span class="line">                <span class="keyword">if</span> (delayCancelException.isAssignableFrom(throwable.getClass())</span><br><span class="line">                        || (rootCause != <span class="keyword">null</span> &amp;&amp; delayCancelException.isAssignableFrom(rootCause.getClass()))) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TransactionManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> TransactionRepository transactionRepository;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt; CURRENT = <span class="keyword">new</span> ThreadLocal&lt;Deque&lt;Transaction&gt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> ExecutorService executorService;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开启事务，持久化到repository，注册到ThreadLocal</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Transaction <span class="title">begin</span><span class="params">(Object uniqueIdentify)</span> </span>&#123;</span><br><span class="line">        Transaction transaction = <span class="keyword">new</span> Transaction(uniqueIdentify,TransactionType.ROOT);</span><br><span class="line">        transactionRepository.create(transaction);</span><br><span class="line">        registerTransaction(transaction);</span><br><span class="line">        <span class="keyword">return</span> transaction;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从主事务的上下文创建分支事务，xid不变，事务类型变化</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Transaction <span class="title">propagationNewBegin</span><span class="params">(TransactionContext transactionContext)</span> </span>&#123;</span><br><span class="line">        Transaction transaction = <span class="keyword">new</span> Transaction(transactionContext);</span><br><span class="line">        transactionRepository.create(transaction);</span><br><span class="line">        registerTransaction(transaction);</span><br><span class="line">        <span class="keyword">return</span> transaction;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从事务上下文同步事务状态到ThreadLocal</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Transaction <span class="title">propagationExistBegin</span><span class="params">(TransactionContext transactionContext)</span> <span class="keyword">throws</span> NoExistedTransactionException </span>&#123;</span><br><span class="line">        Transaction transaction = transactionRepository.findByXid(transactionContext.getXid());</span><br><span class="line">        <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</span><br><span class="line">            transaction.changeStatus(TransactionStatus.valueOf(transactionContext.getStatus()));</span><br><span class="line">            registerTransaction(transaction);</span><br><span class="line">            <span class="keyword">return</span> transaction;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoExistedTransactionException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(<span class="keyword">boolean</span> asyncCommit)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 从ThreadLocal获取当前事务</span></span><br><span class="line">        <span class="keyword">final</span> Transaction transaction = getCurrentTransaction();</span><br><span class="line">        transaction.changeStatus(TransactionStatus.CONFIRMING);</span><br><span class="line">		<span class="comment">// 数据库更新transaction</span></span><br><span class="line">        transactionRepository.update(transaction);</span><br><span class="line">        <span class="keyword">if</span> (asyncCommit) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Long statTime = System.currentTimeMillis();</span><br><span class="line">                <span class="comment">// 通过线程池异步执行事务提交</span></span><br><span class="line">                executorService.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        commitTransaction(transaction);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                logger.debug(<span class="string">"async submit cost time:"</span> + (System.currentTimeMillis() - statTime));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable commitException) &#123;</span><br><span class="line">                logger.warn(<span class="string">"compensable transaction async submit confirm failed, recovery job will try to confirm later."</span>, commitException);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConfirmingException(commitException);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 同步执行事务提交</span></span><br><span class="line">            commitTransaction(transaction);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">commitTransaction</span><span class="params">(Transaction transaction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 调用事务参与者的commit方法</span></span><br><span class="line">            transaction.commit();</span><br><span class="line">            <span class="comment">// 事务结束，在数据库删除当前事务，如果commit异常，不会删除数据库内事务记录，为了重试补偿</span></span><br><span class="line">            transactionRepository.delete(transaction);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable commitException) &#123;</span><br><span class="line">            logger.warn(<span class="string">"compensable transaction confirm failed, recovery job will try to confirm later."</span>, commitException);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfirmingException(commitException);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">(<span class="keyword">boolean</span> asyncRollback)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Transaction transaction = getCurrentTransaction();</span><br><span class="line">        transaction.changeStatus(TransactionStatus.CANCELLING);</span><br><span class="line">        transactionRepository.update(transaction);</span><br><span class="line">        <span class="keyword">if</span> (asyncRollback) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                executorService.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        rollbackTransaction(transaction);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable rollbackException) &#123;</span><br><span class="line">                logger.warn(<span class="string">"compensable transaction async rollback failed, recovery job will try to rollback later."</span>, rollbackException);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> CancellingException(rollbackException);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            rollbackTransaction(transaction);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 把transaction注册到ThreadLocal对象中</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerTransaction</span><span class="params">(Transaction transaction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (CURRENT.get() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            CURRENT.set(<span class="keyword">new</span> LinkedList&lt;Transaction&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        CURRENT.get().push(transaction);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事务结束，从栈中弹出结束的事务</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanAfterCompletion</span><span class="params">(Transaction transaction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isTransactionActive() &amp;&amp; transaction != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Transaction currentTransaction = getCurrentTransaction();</span><br><span class="line">            <span class="keyword">if</span> (currentTransaction == transaction) &#123;</span><br><span class="line">                CURRENT.get().pop();</span><br><span class="line">                <span class="keyword">if</span> (CURRENT.get().size() == <span class="number">0</span>) &#123;</span><br><span class="line">                    CURRENT.remove();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Illegal transaction when clean after completion"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ResourceCoordinatorAspect：主要是为了设置事务的参与者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceCoordinatorAspect</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ResourceCoordinatorInterceptor resourceCoordinatorInterceptor;</span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"@annotation(org.mengyun.tcctransaction.api.Compensable)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transactionContextCall</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"transactionContextCall()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptTransactionContextMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> resourceCoordinatorInterceptor.interceptTransactionContextMethod(pjp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResourceCoordinatorInterceptor</span><span class="params">(ResourceCoordinatorInterceptor resourceCoordinatorInterceptor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.resourceCoordinatorInterceptor = resourceCoordinatorInterceptor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ResourceCoordinatorInterceptor：主要处理 try 阶段的事情，在 try 阶段，就将所有的“资源”封装完成并交给事务管理器。然后事务管理器修改数据库状态。</p>
<p>“资源”指“事务资源”，即事务的参与者：confirm上下文，cancel上下文，分支事务信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceCoordinatorInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> TransactionManager transactionManager;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTransactionManager</span><span class="params">(TransactionManager transactionManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.transactionManager = transactionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">interceptTransactionContextMethod</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		<span class="comment">// 获取当前事务</span></span><br><span class="line">        Transaction transaction = transactionManager.getCurrentTransaction();</span><br><span class="line">        <span class="keyword">if</span> (transaction != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (transaction.getStatus()) &#123;</span><br><span class="line">				<span class="comment">// 只需要在trying时，获取到参与者信息，并设置到transaction中</span></span><br><span class="line">                <span class="keyword">case</span> TRYING:</span><br><span class="line">                    enlistParticipant(pjp);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> CONFIRMING:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> CANCELLING:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 执行目标方法</span></span><br><span class="line">        <span class="keyword">return</span> pjp.proceed(pjp.getArgs());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enlistParticipant</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> IllegalAccessException, InstantiationException </span>&#123;</span><br><span class="line">		<span class="comment">// 获取@Compensable注解信息</span></span><br><span class="line">        Method method = CompensableMethodUtils.getCompensableMethod(pjp);</span><br><span class="line">        <span class="keyword">if</span> (method == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(String.format(<span class="string">"join point not found method, point is : %s"</span>, pjp.getSignature().getName()));</span><br><span class="line">        &#125;</span><br><span class="line">        Compensable compensable = method.getAnnotation(Compensable<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        String confirmMethodName = compensable.confirmMethod();</span><br><span class="line">        String cancelMethodName = compensable.cancelMethod();</span><br><span class="line">        Transaction transaction = transactionManager.getCurrentTransaction();</span><br><span class="line">        TransactionXid xid = <span class="keyword">new</span> TransactionXid(transaction.getXid().getGlobalTransactionId());</span><br><span class="line">        <span class="keyword">if</span> (FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().get(pjp.getTarget(), method, pjp.getArgs()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            FactoryBuilder.factoryOf(compensable.transactionContextEditor()).getInstance().set(<span class="keyword">new</span> TransactionContext(xid, TransactionStatus.TRYING.getId()), pjp.getTarget(), ((MethodSignature) pjp.getSignature()).getMethod(), pjp.getArgs());</span><br><span class="line">        &#125;</span><br><span class="line">        Class targetClass = ReflectionUtils.getDeclaringType(pjp.getTarget().getClass(), method.getName(), method.getParameterTypes());</span><br><span class="line">        InvocationContext confirmInvocation = <span class="keyword">new</span> InvocationContext(targetClass,</span><br><span class="line">                confirmMethodName,</span><br><span class="line">                method.getParameterTypes(), pjp.getArgs());</span><br><span class="line">        InvocationContext cancelInvocation = <span class="keyword">new</span> InvocationContext(targetClass,</span><br><span class="line">                cancelMethodName,</span><br><span class="line">                method.getParameterTypes(), pjp.getArgs());</span><br><span class="line">        Participant participant =</span><br><span class="line">                <span class="keyword">new</span> Participant(</span><br><span class="line">                        xid,</span><br><span class="line">                        confirmInvocation,</span><br><span class="line">                        cancelInvocation,</span><br><span class="line">                        compensable.transactionContextEditor());</span><br><span class="line">        transactionManager.enlistParticipant(participant);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时经过两个拦截器后，才调用到目标对象方法，即对应try逻辑的被切方法。</p>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css"></div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Distribution/">Distribution</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/07/25/RedisDistributedLock/"><span class="level-item">RedisDistributedLock</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/valine/1.4.14/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "EUMJSoVQNU9husSvEa2sjwgu-gzGzoHsz",
            appKey: "cIlIfJdKwlBAIbyYgLpDc1WT",
            
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "zh-CN",
            
            highlight: true,
            
            
            
            
            
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="is-flex" href="#分布式事务"><span class="mr-2">1</span><span>分布式事务</span></a><ul class="menu-list"><li><a class="is-flex" href="#事务简介"><span class="mr-2">1.1</span><span>事务简介</span></a></li><li><a class="is-flex" href="#什么是分布式事务"><span class="mr-2">1.2</span><span>什么是分布式事务</span></a></li><li><a class="is-flex" href="#实现思路"><span class="mr-2">1.3</span><span>实现思路</span></a><ul class="menu-list"><li><a class="is-flex" href="#两段式事务"><span class="mr-2">1.3.1</span><span>两段式事务</span></a></li><li><a class="is-flex" href="#三段式事务"><span class="mr-2">1.3.2</span><span>三段式事务</span></a></li><li><a class="is-flex" href="#基于XA的分布式事务"><span class="mr-2">1.3.3</span><span>基于XA的分布式事务</span></a></li><li><a class="is-flex" href="#基于消息的最终一致性方案"><span class="mr-2">1.3.4</span><span>基于消息的最终一致性方案</span></a></li><li><a class="is-flex" href="#举例"><span class="mr-2">1.3.5</span><span>举例</span></a></li></ul></li><li><a class="is-flex" href="#分布式事务框架"><span class="mr-2">1.4</span><span>分布式事务框架</span></a></li><li><a class="is-flex" href="#TCC-Transaction分析"><span class="mr-2">1.5</span><span>TCC-Transaction分析</span></a><ul class="menu-list"><li><a class="is-flex" href="#使用方法"><span class="mr-2">1.5.1</span><span>使用方法</span></a></li><li><a class="is-flex" href="#源码分析"><span class="mr-2">1.5.2</span><span>源码分析</span></a></li></ul></li></ul></li></ul></div></div></div><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/2.png" alt="Jiayi Yang"></figure><p class="title is-size-4 is-block line-height-inherit">Jiayi Yang</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Hangzhou, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">23</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">1</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">10</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/JiayiY" target="_blank" rel="noopener">关注我</a></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/%E5%89%91%E6%8C%87offer/"><span class="level-start"><span class="level-item">剑指offer</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2020-07-26T10:30:01.000Z">2020-07-26</time></p><p class="title is-6"><a class="link-muted" href="/2020/07/26/DistributedTransaction/">DistributedTransaction</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-07-25T09:21:46.000Z">2020-07-25</time></p><p class="title is-6"><a class="link-muted" href="/2020/07/25/RedisDistributedLock/">RedisDistributedLock</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-07-25T08:06:38.000Z">2020-07-25</time></p><p class="title is-6"><a class="link-muted" href="/2020/07/25/Redis/">Redis</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-07-24T08:16:44.000Z">2020-07-24</time></p><p class="title is-6"><a class="link-muted" href="/2020/07/24/JavaBasicProblem/">JavaBasicProblem</a></p><p class="is-uppercase"></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-07-21T10:14:09.000Z">2020-07-21</time></p><p class="title is-6"><a class="link-muted" href="/2020/07/21/Dubbo/">Dubbo</a></p><p class="is-uppercase"></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">20</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2020/06/"><span class="level-start"><span class="level-item">六月 2020</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Distribution/"><span class="tag">Distribution</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Dubbo/"><span class="tag">Dubbo</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JVM/"><span class="tag">JVM</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring/"><span class="tag">Spring</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/concurrent/"><span class="tag">concurrent</span><span class="tag is-grey-lightest">12</span></a></div><div class="control"><a class="tags has-addons" href="/tags/dp/"><span class="tag">dp</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lc/"><span class="tag">lc</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lcof/"><span class="tag">lcof</span><span class="tag is-grey-lightest">2</span></a></div></div></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button is-primary" type="submit" value="订阅"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a><p class="size-small"><span>&copy; 2020 Jiayi Yang</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'http://yoursite.com',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><form class="searchbox-input-container"><input class="searchbox-input" name="wd" type="text" placeholder="想要查找什么..."></form><a class="searchbox-close" href="javascript:;">×</a></div></div></div><script>(function ($) {
            $('.searchbox-input-container').on('submit', function (e) {
                var keyword = $('.searchbox-input[name="wd"]').val();
                window.location = 'https://www.baidu.com/s?wd=site:yoursite.com ' + keyword;
                return false;
            });
        })(jQuery);
        (function (document, $) {
            $(document).on('click', '.navbar-main .search', function () {
                $('.searchbox').toggleClass('show');
            }).on('click', '.searchbox .searchbox-mask', function () {
                $('.searchbox').removeClass('show');
            }).on('click', '.searchbox-close', function () {
                $('.searchbox').removeClass('show');
            });
        })(document, jQuery);</script></body></html>